<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/login.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/login.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { tbl_usuario } from "../models/tbl_Usuario.js";
import { tbl_Rol } from "../models/tbl_Rol.js";
import bcrypt from "bcrypt";
import jwt from 'jsonwebtoken'
import dotenv from 'dotenv'
import cookieParser from "cookie-parser";
import { Op } from "sequelize";

dotenv.config();

// FUNCION PARA REGISTRAR USUARIO
/**
 * Registra un nuevo usuario en la base de datos.
 *
 * Esta función recibe los datos de un nuevo usuario y lo registra en la base de datos. Antes de registrar el usuario, 
 * verifica si el usuario ya está registrado mediante su cédula. Si no lo está, encripta la contraseña utilizando bcrypt 
 * y luego inserta los datos en la tabla de usuarios.
 *
 * @async
 * @function func_registrarUsuario
 * @param {Object} req - Objeto de solicitud (Request) de Express.
 * @param {Object} req.body - El cuerpo de la solicitud que contiene los datos del usuario a registrar.
 * @param {string} req.body.cedulaUsuario - La cédula del usuario.
 * @param {string} req.body.nombreUsuario - El nombre completo del usuario.
 * @param {string} req.body.telefonoUsuario - El número de teléfono del usuario.
 * @param {string} req.body.correoUsuario - El correo electrónico del usuario.
 * @param {string} req.body.paswordUsuario - La contraseña del usuario, que será encriptada antes de guardarla.
 * @param {number} req.body.idRol - El ID del rol asignado al usuario.
 * @param {Object} res - Objeto de respuesta (Response) de Express.
 * @returns {JSON} Devuelve un objeto JSON que indica el éxito o el error de la operación.
 * @throws {Error} Devuelve un error si ocurre un problema durante el registro del usuario o la encriptación de la contraseña.
 */

export const func_registrarUsuario = async (req, res) => {

    const { cedulaUsuario, nombreUsuario, telefonoUsuario, correoUsuario, paswordUsuario, idRol } = req.body;

    try {

        if (cedulaUsuario != "" &amp;&amp; nombreUsuario != "" &amp;&amp; telefonoUsuario != "" &amp;&amp; correoUsuario != "" &amp;&amp; paswordUsuario != "" &amp;&amp; idRol != "") {
            const salRondas = 10;
            const contraIncriptada = `s0/\/${paswordUsuario}\P4$$w0rD`;

            // funcion para saber si el usuario ya esta registrado
            const usuarioExiste = await tbl_usuario.findOne({ where: { cedula: cedulaUsuario } });
            if (usuarioExiste === null) {
                //  PARA INCRITAR LA CONTRASEÑA UTILIZANDO BCRYPT
                bcrypt.hash(contraIncriptada, salRondas, async function (err, hash) {
                    if (!err) {

                        const insertacion = await tbl_usuario.create({
                            cedula: cedulaUsuario,
                            nombreCompleto: nombreUsuario,
                            telefono: telefonoUsuario,
                            correo: correoUsuario,
                            password: hash,
                            RolId: idRol,
                        });
                        // Todo salió bien, enviamos la respuesta exitosa
                        res.status(200).send({
                            status: true,
                            descripcion: "Usuario insertado con exito",
                            datos: insertacion,
                            error: null
                        })
                    }
                    else {
                        res.status(200).send({
                            status: false,
                            descripcion: "Hubo un error al Incriptar la Contraseña",
                            datos: null,
                            error: err
                        })
                    }


                });
                //  FIN INCRITACION 

            } else {

                res.status(200).send({
                    status: false,
                    descripcion: "Usuario ya esta Registrado",
                    datos: null,
                    error: null
                })

            }
        }
        else {
            res.status(200).send({
                status: false,
                descripcion: "Esta mandando datos Vacios",
                datos: null,
                error: null
            })
        }


    } catch (error) {
        res.status(200).send({
            status: false,
            descripcion: "No se pudo Insertar los datos",
            datos: null,
            error: error
        })
    }
}

// -- FIN FUNCION --



// FUNCION INICIAR SESION
/**
 * Inicia sesión en el sistema.
 *
 * Esta función autentica a un usuario mediante su correo y contraseña. Si las credenciales son correctas, 
 * se genera un token JWT que permite el acceso a las funcionalidades protegidas del sistema. Si las credenciales 
 * no coinciden o el usuario no está registrado, se devuelve un mensaje de error adecuado.
 *
 * @async
 * @function func_iniciarSesion
 * @param {Object} req - Objeto de solicitud (Request) de Express.
 * @param {Object} req.body - El cuerpo de la solicitud que contiene las credenciales del usuario.
 * @param {string} req.body.correo - El correo electrónico del usuario.
 * @param {string} req.body.contra - La contraseña del usuario.
 * @param {Object} res - Objeto de respuesta (Response) de Express.
 * @returns {JSON} Devuelve un objeto JSON que indica el éxito o el error de la operación, junto con un token JWT si la autenticación es exitosa.
 * @throws {Error} Devuelve un error si ocurre un problema durante la autenticación del usuario.
 */

export const func_iniciarSesion = async (req, res) => {

    let correo = req.body.correo;
    let contra = req.body.contra;
    try {
        if (correo != "" &amp;&amp; contra != "") {
            // aca voy a traer los datos del Usuario con el correo si devuelve null es porque no esta registrado
            const verificacionCorreo = await tbl_usuario.findAll({
                where: {
                    correo: correo,
                },
            });

            if (verificacionCorreo.length > 0) {

                let contraBaseDatos = verificacionCorreo[0].password

                if (bcrypt.compareSync(`s0/\/${contra}\P4$$w0rD`, contraBaseDatos)) {

                    const token = jwt.sign({ datos: verificacionCorreo },
                        process.env.SECRET_JWT_KEY,
                        {
                            expiresIn: '12h'
                        }
                    )

                    res.status(200).send({
                        status: true,
                        descripcion: "Exitoso Considen los Usuarios",
                        error: null,
                        token: token,
                        datos: verificacionCorreo
                    })

                }
                else {
                    res.status(200).send({
                        status: false,
                        descripcion: "Contraseña Incorrecta",
                        error: null,
                        token: null,
                        datos: null
                    })
                }
            }
            else {
                res.status(200).send({
                    status: false,
                    descripcion: "Usuario no Registrado",
                    error: null,
                    token: null,
                    datos: null
                })
            }
        }
        else {
            res.status(200).send({
                status: false,
                descripcion: "Esta mandando Datos vacios",
                error: null,
                token: null,
                datos: null
            })
        }

    } catch (error) {
        res.status(500).send({
            status: false,
            descripcion: "Hubo un error en la API",
            error: error.message,
            token: null,
            datos: null
        })
    }
}

// -- FIN FUNCION --


// FUNCION PARA SELECCIONAR ROLES

export const fuc_selecionarRoles = async (req, res) => {

    try {
        const traerRoles = await tbl_Rol.findAll({
            where: {
                descripcion: {
                    [Op.ne]: 'ADMIN'  // Selecciona todos los registros donde 'rol' no sea 'ADMIN'
                }

            },
        });


        res.status(200).send({
            status: true,
            descripcion: "Consulta Exitosa!! Roles Traidos",
            error: null,
            datos: traerRoles
        })


    } catch (error) {
        res.status(500).send({
            status: false,
            descripcion: "Hubo un error en la API",
            error: error.message,
            datos: null
        })
    }
}

// -- FIN FUNCION --</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#CambiarEstadoUsuario">CambiarEstadoUsuario</a></li><li><a href="global.html#EditarUsuario">EditarUsuario</a></li><li><a href="global.html#TraerTodosUsuarios">TraerTodosUsuarios</a></li><li><a href="global.html#TraerUsuarioId">TraerUsuarioId</a></li><li><a href="global.html#almacenamiento">almacenamiento</a></li><li><a href="global.html#cambiarEstadoEvento">cambiarEstadoEvento</a></li><li><a href="global.html#crearCierre">crearCierre</a></li><li><a href="global.html#crearEvento">crearEvento</a></li><li><a href="global.html#crearUsuario">crearUsuario</a></li><li><a href="global.html#editarCierre">editarCierre</a></li><li><a href="global.html#editarEvento">editarEvento</a></li><li><a href="global.html#func_EditarMenu">func_EditarMenu</a></li><li><a href="global.html#func_EditarPedido">func_EditarPedido</a></li><li><a href="global.html#func_EliminarMenu">func_EliminarMenu</a></li><li><a href="global.html#func_InsertarMenu">func_InsertarMenu</a></li><li><a href="global.html#func_InsertarPedido">func_InsertarPedido</a></li><li><a href="global.html#func_iniciarSesion">func_iniciarSesion</a></li><li><a href="global.html#func_registrarUsuario">func_registrarUsuario</a></li><li><a href="global.html#func_selecionarTodosLosMenus">func_selecionarTodosLosMenus</a></li><li><a href="global.html#traerCierreID">traerCierreID</a></li><li><a href="global.html#traerEventoId">traerEventoId</a></li><li><a href="global.html#traerTodosCierre">traerTodosCierre</a></li><li><a href="global.html#traerTodosEventos">traerTodosEventos</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Wed Aug 14 2024 06:17:26 GMT-0500 (hora estándar de Colombia)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
